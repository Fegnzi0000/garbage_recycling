# 个人下单回收模块代码修改说明 (更新版)

> 最近更新日期：2025-09-28
>
> 本文在原始“个人下单回收模块”完成后，补充记录后续新增的高校下单、地址管理、价格计算、实体字段扩展、测试脚本与 BUG 修复等所有改动，便于团队成员同步最新设计与代码演进脉络。

---
## 目录
1. 初版回顾（个人下单功能）
2. 后续新增与调整总览
3. 新增/修改的核心模块与文件清单
4. 实体与数据库结构最新说明
5. 订单创建/金额/地址/鉴权流程最新说明
6. 已修复问题与设计权衡
7. 测试脚本与调试方式（HTTP 文件说明）
8. 待改进 / 下一步规划
9. 版本里程碑与时间线

---
## 1. 初版回顾（个人下单功能）
初版交付内容（已在之前文档中说明）：
- 支持个人用户：创建订单 / 查询订单列表 / 取消订单
- 依赖：MyBatis-Plus、JWT 登录态、微信模拟登录（WeChatUtil 测试code）
- 核心类：`PersonOrderService(Impl)`、`OrderController`、`Order`、`OrderMapper`、`Result`、`JwtInterceptor` / `WebMvcConfig`

> 注意：初版文档中提及的 `OrderService / OrderServiceImpl` 命名与当前代码不完全一致，实际已采用更明确的 `PersonOrderService / PersonOrderServiceImpl`。

---
## 2. 后续新增与调整总览
| 类别 | 说明 | 状态 |
|------|------|------|
| 高校下单模块 | 新增教材回收 / 宿舍批量回收 | 已完成 |
| 地址管理模块 | 新增地址实体、创建/列表/设置默认接口 | 已完成 |
| 价格计算模块 | PriceConfig + PriceCalculationService(Impl) | 已完成（高校使用，个人暂为 0） |
| 订单实体扩展 | campus_type / campus_info / estimated_amount 默认逻辑 / items 默认值 | 已完成 |
| DTO 扩展 | TextbookOrderDTO / DormitoryOrderDTO + items 可选字段 | 已完成 |
| WeChat 测试能力 | test_mode + 动态 test_code 支持 | 已完成 |
| 时间戳自动填充 | MyMetaObjectHandler | 已完成 |
| 全局参数校验 | 加入 jakarta validation + @Valid | 已完成 |
| BUG 修复 | Field 'items' doesn't have a default value | 已修复（多层兜底） |
| HTTP 测试脚本 | 全链路包含：登录→建地址→个人下单→高校教材→高校宿舍 | 已更新 |
| 统一返回 | 高校下单返回 estimatedAmount | 已完成 |

---
## 3. 新增/修改的核心模块与文件清单

### 3.1 新增文件
| 文件 | 作用 |
|------|------|
| `CampusOrderService` / `CampusOrderServiceImpl` | 高校订单创建（教材 / 宿舍）与高校身份校验 |
| `TextbookOrderDTO` / `DormitoryOrderDTO` | 高校订单专用请求数据载体（含 items 可选） |
| `UserAddress` | 用户地址实体，对应 `user_address` 表 |
| `UserAddressMapper` / `UserAddressService(Impl)` | 地址数据访问与归属校验 |
| `AddressController` | 地址创建 / 列表 / 设置默认接口 |
| `PriceConfig` | 基础价格 + 试点期价格配置（内置初值，可扩展 YAML 配置） |
| `PriceCalculationService` / `PriceCalculationServiceImpl` | 高校订单金额估算逻辑（教材 / 宿舍） |
| `MyMetaObjectHandler` | MyBatis-Plus 自动填充 createdAt / updatedAt |
| `SnowflakeIdGenerator` | 高校订单号（CAMP 前缀）生成 |
| `OrderTest.http`（更新） | 集成测试脚本，覆盖全流程 |
| `AddressCreateDTO` | 创建地址请求体 |

### 3.2 重要修改文件
| 文件 | 修改要点 |
|------|-----------|
| `Order.java` | 新增 `campusType`、`campusInfo`、为 `items` 增加默认值`"[]"`，保留金额字段；增加中文注释 |
| `CampusOrderController` | 新增高校教材/宿舍下单 API，启用 @Valid |
| `PersonOrderServiceImpl` | 地址合法性校验；个人预估金额固定 0；日志增强 |
| `CampusOrderServiceImpl` | 地址校验 + items 可选保存 + estimatedAmount 计算 + 日志输出 |
| `WeChatUtil` | test_mode 支持 test_code_* 动态模拟；增强测试便利性 |
| `application.yml` | 统一 UTF-8、修正 mybatis-plus 包路径、加入价格配置、数据库 URL 规范化 |
| `pom.xml` | 添加 validation 依赖、编码属性、编译插件编码设置 |
| `GlobalExceptionHandler`（若存在） | 处理参数校验异常（收集 message） |
| `Result.java` | 支持链式 put；统一响应格式 |

### 3.3 删除/废弃注意
无强制废弃项；仅语义调整（命名从“OrderService”过渡为“PersonOrderService”）。

---
## 4. 实体与数据库结构最新说明
### 4.1 `order` 表（新增 / 关注字段）
| 字段 | 说明 | 备注 |
|------|------|------|
| order_no | 订单号 | 个人：`ORD+UUID16`；高校：`CAMP+雪花ID` |
| order_type | 1=个人 2=高校 | 用于业务分流 |
| campus_type | 1=教材 2=宿舍 | 高校子类型 |
| campus_info | 高校扩展 JSON | 存教材/宿舍特征字段 |
| items | JSON（默认 "[]"） | 个人：物品明细；高校：可选传入/默认空数组 |
| estimated_amount | 预估金额 | 高校订单由价格模块赋值；个人=0 |
| final_amount | 最终金额 | 后续结算使用（暂未实现流程） |

### 4.2 `user_address` 表
现有结构：`id,user_id,address_label,detail_address,contact_name,contact_phone,location,is_default,created_at,updated_at`
> 无 province/city/district 字段，实体已对齐；location 以 JSON 字符串存储（可后续加 TypeHandler）。

---
## 5. 最新业务流程说明
### 5.1 个人下单流程
1. 校验 token → 获取 userId  
2. 校验 addressId 归属  
3. 固定预估金额=0（暂不计价）  
4. 持久化：items、images、scheduledTime  
5. 返回 orderNo / orderId

### 5.2 高校教材回收下单
1. 校验高校身份 (identityType=2)  
2. 校验 addressId 归属  
3. 金额估算：basePrice(waste_paper) × quantity × condition 系数  
4. 保存 campusInfo + 可选 items  
5. 返回 orderNo + estimatedAmount

### 5.3 高校宿舍批量回收下单
1. 同上身份+地址校验  
2. 金额估算：遍历 recyclingCategories → price × 预估重量 → 累加  
3. 保存 campusInfo + 可选 items  
4. 返回 orderNo + estimatedAmount

### 5.4 地址管理
- 创建：可设 isDefault；若设置则清除旧默认
- 列表：按 id DESC 返回
- 设置默认：原默认清零→目标设置为1

### 5.5 价格计算（试点期）
| 条件 | 系数 | 备注 |
|------|------|------|
| 全新 | 1.2 |  | 
| 九成新 | 1.0 |  | 
| 八成新 | 0.9 |  | 
| 七成新 | 0.8 |  | 
| 六成新 | 0.7 |  | 
| 五成新 | 0.6 |  | 
| 四成新 | 0.5 |  | 
| 三成新 | 0.4 |  | 
| 二成新 | 0.35 | 默认最低回退 0.3 |

> 配置项：`recycling.price.pilot.period=true` 控制试点价；后续可加 enabled 开关。

### 5.6 WeChat 测试模式
- 配置：`wechat.test.mode=true`
- 支持：`test_code_person` / `test_code_campus` / 动态 `test_code_*`
- 真实 API 失败不影响测试流程（本地 mock 返回 openid）。

---
## 6. 已修复问题与设计权衡
| 问题 | 现象 | 处理方案 | 备注 |
|------|------|---------|------|
| application.yml 编码异常 | 启动 YAML 解析失败 | 统一 UTF-8 + VM `-Dfile.encoding=UTF-8` | 已稳定 |
| Field 'items' doesn't have a default value | 高校订单插入失败 | 三层兜底：服务层 setItems / 实体默认值 / 前端可传 | 已解决 |
| 地址外键约束失败 | 地址不存在或归属不符 | 下单前校验 + 明确错误提示 | 支持多用户并发 |
| 校园订单金额为 0 | 未接入计算 | 接入 PriceCalculationService | 教材/宿舍已生效 |
| 测试 code 无法登录 | 40029 invalid code | test_modeMock + 动态生成 | 支持多场景 |

---
## 7. 测试脚本与调试方式
`src/test/java/OrderTest.http` 覆盖：
1. 个人登录 → 创建地址 → 个人下单  
2. 高校登录 → 创建地址 → 教材下单（含 items）  
3. 宿舍下单（含 categories 与 items）  
4. 断言：状态码=200、捕获 token、地址ID、orderNo、estimatedAmount  

> 建议：IDEA 直接“Run All”分步观察；数据库配合 `SELECT * FROM order ORDER BY id DESC LIMIT 5;` 验证。

---
## 8. 待改进 / 下一步规划
| 优先级 | 事项 | 说明 |
|--------|------|------|
| 高 | 统一订单状态/类型枚举 | 消除魔法数字，集中常量管理 |
| 高 | 订单详情接口 | 解析 campusInfo & items 返回结构化数据 |
| 中 | 金额计算开关 | `recycling.price.enabled` + 动态策略扩展 |
| 中 | 地址修改/删除接口 | 支持地址维护生命周期 |
| 中 | 日志 & 审计 | AOP 记录下单 / 取消 / 估价关键参数 |
| 低 | 统一异常码 | 规范化 code（如 400/401/403/500） |
| 低 | 国际化支持 | message 外置化 |
| 低 | 单元 / 集成测试完善 | 覆盖 PriceCalculation / CampusOrder / AddressController |

---
## 9. 版本里程碑与时间线
| 日期 | 里程碑 | 说明 |
|------|--------|------|
| 初版（之前） | 个人下单模块 | 基础 CRUD + JWT 鉴权 |
| 2025-09-28 (上午) | 价格计算草案接入 | 高校订单初步计算逻辑接入 |
| 2025-09-28 (中午) | 高校教材/宿舍接口完成 | DTO + 校验 + 金额 + campusInfo |
| 2025-09-28 (下午) | 地址管理模块上线 | create / list / default + 校验链路打通 |
| 2025-09-28 (下午) | items NOT NULL BUG 修复 | 三层兜底策略完成 |
| 2025-09-28 (晚) | 测试脚本全流程串通 | HTTP 脚本 + 动态变量 | 

---
## 附：当前关键 API 列表（节选）
| 接口 | 方法 | 说明 |
|------|------|------|
| /auth/wechat/login | POST | 获取 token（支持测试 code） |
| /address/create | POST | 创建地址 |
| /address/list | GET | 地址列表 |
| /order/personal | POST | 个人下单 |
| /order/list | GET | 个人订单列表 |
| /order/cancel/{id} | POST | 取消个人订单 |
| /campusOrder/textbook | POST | 高校教材订单创建 |
| /campusOrder/dormitory | POST | 高校宿舍订单创建 |

---
## 总结
当前系统已从“仅支持个人下单”扩展为“个人 + 高校（教材/宿舍）+ 地址管理 + 基础价格计算”一体化订单模块。核心链路（认证 → 地址 → 下单 → 金额估算 → 数据持久化 → 测试验证）已完整跑通。推荐下一阶段聚焦：
1. 枚举/常量规范化
2. 订单详情/状态流转扩展
3. 统一监控 & 审计可观测性
4. 测试覆盖率提升

如需为研发/测试同学快速培训，可基于本说明提炼一份《功能使用与调试手册》。

---
> 若本文件与代码存在偏差，请以最新代码为准，并及时回写文档保持一致性。
